#!/bin/bash
set -euo pipefail

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
RESULTS_DIR="$HOME/etcd_benchmark_$(date +%Y%m%d_%H%M%S)"
FIO_SIZE="1G"
FIO_RUNTIME=60
FIO_JOBS=4

# Create results directory
mkdir -p "$RESULTS_DIR"
log_file="$RESULTS_DIR/etcd_benchmark.log"

# Logging functions
log() {
  local level=$1
  shift
  local color
  local level_upper
  level_upper=$(echo "$level" | tr '[:lower:]' '[:upper:]')
  
  case "$level" in
    info) color="$GREEN" ;;
    warn) color="$YELLOW" ;;
    error) color="$RED" ;;
    *) color="$NC" ;;
  esac

  local timestamp
  timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  local message="[$timestamp] $level_upper: $*"
  
  echo -e "${color}${message}${NC}" | tee -a "$log_file"
}

log_info() {
  log info "$@"
}

log_warn() {
  log warn "$@"
}

log_error() {
  log error "$@"
  exit 1
}

log_section() {
  echo -e "\n${BLUE}===== $* =====${NC}" | tee -a "$log_file"
}

# Check prerequisites
check_prerequisites() {
  log_section "Checking Prerequisites"
  
  # Check oc is installed and logged in
  if ! command -v oc &> /dev/null; then
    log_error "OpenShift CLI (oc) is not installed or not in PATH"
  fi
  
  # Check cluster connection
  if ! oc whoami &> /dev/null; then
    log_error "Not logged into OpenShift cluster. Please run 'oc login' first."
  fi
  
  # Check if user has cluster-admin privileges
  if ! oc auth can-i '*' '*' --all-namespaces &> /dev/null; then
    log_warn "User does not have cluster-admin privileges. Some checks may fail."
  fi
  
  log_info "All prerequisites met"
}

# Get etcd pods
get_etcd_pods() {
  oc get pods -n openshift-etcd -l app=etcd -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' 2>/dev/null
}

# Run FIO test on node
run_fio_test() {
  local node=$1
  local test_name=$2
  local fio_params=$3
  
  local result_file="$RESULTS_DIR/fio_${node//\//_}_${test_name}.json"
  local log_file="$RESULTS_DIR/fio_${node//\//_}_${test_name}.log"
  
  log_info "Running FIO test '$test_name' on $node"
  
  {
    echo "=== FIO Test: $test_name ==="
    echo "Node: $node"
    echo "Command: fio --output-format=json $fio_params"
    echo "Timestamp: $(date)"
    echo "==========================="
    echo
  } > "$log_file"
  
  local start_time
  start_time=$(date +%s)
  
  local result
  result=$(oc debug "node/$node" --quiet -- chroot /host bash -c "
    # Install fio if not present
    if ! command -v fio &> /dev/null; then
      if command -v dnf &> /dev/null; then
        dnf install -y fio || yum install -y fio || {
          echo 'ERROR: Failed to install fio' >&2
          exit 1
        }
      else
        echo 'ERROR: Could not find package manager to install fio' >&2
        exit 1
      fi
    fi
    
    # Create test file
    test_file=\"/var/tmp/fio_test\"
    fallocate -l 2G \"\$test_file\" || {
      echo 'ERROR: Failed to create test file' >&2
      exit 1
    }
    
    # Run fio test
    fio --filename=\$test_file --output-format=json $fio_params 2>&1 || {
      echo 'ERROR: FIO test failed' >&2
      exit 1
    }
    
    # Cleanup
    rm -f \"\$test_file\"
  " 2>&1)
  
  local exit_code=$?
  local end_time
  end_time=$(date +%s)
  local duration=$((end_time - start_time))
  
  {
    echo
    echo "=== Test Completed ==="
    echo "Exit Code: $exit_code"
    echo "Duration: ${duration}s"
    echo "====================="
  } >> "$log_file"
  
  if [ $exit_code -ne 0 ]; then
    log_error "FIO test '$test_name' failed on $node. Check $log_file for details."
    echo "$result" >> "$log_file"
    return 1
  fi
  
  # Save results
  echo "$result" > "$result_file"
  log_info "FIO test '$test_name' completed in ${duration}s. Results saved to $result_file"
  
  # Parse and log summary
  local iops
  iops=$(echo "$result" | jq -r '.jobs[0].write.iops // 0')
  local lat
  lat=$(echo "$result" | jq -r '.jobs[0].write.lat_ns.mean // 0')
  lat=$(awk "BEGIN {printf \"%.2f\", $lat/1000000}") # Convert ns to ms
  
  log_info "Test '$test_name' summary - IOPS: $iops, Latency: ${lat}ms"
  
  # Return the raw result
  echo "$result"
}

# Main function
main() {
  log_section "Starting etcd Performance Benchmark"
  log_info "Results will be saved to: $RESULTS_DIR"
  
  check_prerequisites
  
  # Get etcd nodes
  log_section "Discovering etcd Nodes"
  local etcd_nodes
  etcd_nodes=$(oc get nodes -l node-role.kubernetes.io/master= -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}')
  
  if [ -z "$etcd_nodes" ]; then
    log_error "No etcd nodes found"
  fi
  
  log_info "Found etcd nodes:"
  echo "$etcd_nodes" | while read -r node; do
    log_info "- $node"
  done
  
  # Run FIO tests on each etcd node
  log_section "Running Disk Performance Tests"
  for node in $etcd_nodes; do
    log_info "Testing node: $node"
    
    # Sequential write test
    run_fio_test "$node" "seq_write" "\
      --name=seq_write \
      --size=$FIO_SIZE \
      --runtime=$FIO_RUNTIME \
      --ioengine=sync \
      --rw=write \
      --bs=4k \
      --numjobs=1 \
      --time_based \
      --direct=1 \
      --group_reporting"
    
    # Random write test
    run_fio_test "$node" "rand_write" "\
      --name=rand_write \
      --size=$FIO_SIZE \
      --runtime=$FIO_RUNTIME \
      --ioengine=libaio \
      --rw=randwrite \
      --bs=4k \
      --numjobs=$FIO_JOBS \
      --time_based \
      --direct=1 \
      --group_reporting"
    
    # Fsync test
    run_fio_test "$node" "fsync" "\
      --name=fsync \
      --size=1G \
      --filesize=1G \
      --ioengine=sync \
      --rw=write \
      --bs=4k \
      --numjobs=1 \
      --fsync=1 \
      --time_based \
      --runtime=30 \
      --direct=1 \
      --group_reporting"
  done
  
  # Collect etcd metrics
  log_section "Collecting etcd Metrics"
  local metrics_file="$RESULTS_DIR/etcd_metrics.json"
  oc get --raw /metrics > "$metrics_file" 2>/dev/null || log_warn "Failed to collect etcd metrics"
  
  # Collect etcd status
  log_section "Collecting etcd Status"
  local status_file="$RESULTS_DIR/etcd_status.log"
  {
    echo "=== etcdctl member list ==="
    oc rsh -n openshift-etcd "$(oc get pods -n openshift-etcd -l app=etcd -o name | head -1)" etcdctl member list -w table || true
    
    echo -e "\n=== etcdctl endpoint status ==="
    oc rsh -n openshift-etcd "$(oc get pods -n openshift-etcd -l app=etcd -o name | head -1)" etcdctl endpoint status -w table --cluster || true
    
    echo -e "\n=== etcdctl endpoint health ==="
    oc rsh -n openshift-etcd "$(oc get pods -n openshift-etcd -l app=etcd -o name | head -1)" etcdctl endpoint health --cluster || true
  } > "$status_file" 2>&1
  
  log_info "etcd status saved to $status_file"
  
  # Generate summary report
  log_section "Generating Summary Report"
  local summary_file="$RESULTS_DIR/summary.txt"
  {
    echo "=== etcd Performance Benchmark Summary ==="
    echo "Date: $(date)"
    echo "OpenShift Version: $(oc version -o json | jq -r .serverVersion.gitVersion)"
    echo "Test Duration: $(( ( $(date +%s) - $(date -d @"$(stat -c %Y "$log_file")" +%s) )) seconds"
    echo "Results Directory: $RESULTS_DIR"
    echo "========================================"
    echo
    
    # FIO results summary
    echo "=== Disk Performance ==="
    find "$RESULTS_DIR" -name "fio_*.json" | while read -r f; do
      local node_test
      node_test=$(basename "$f" .json | sed 's/fio_//')
      local iops
      iops=$(jq -r '.jobs[0].write.iops // 0' "$f")
      local lat
      lat=$(jq -r '.jobs[0].write.lat_ns.mean // 0' "$f")
      lat=$(awk "BEGIN {printf \"%.2f\", $lat/1000000}") # Convert ns to ms
      
      printf "%-40s: IOPS=%8.2f, Latency=%6.2fms\n" "$node_test" "$iops" "$lat"
    done
    
    # etcd status summary
    echo -e "\n=== etcd Cluster Status ==="
    grep -A 10 "etcdctl member list" "$status_file" | tail -n +2
  } > "$summary_file"
  
  log_info "Benchmark completed successfully!"
  log_info "Summary report: $summary_file"
  log_info "Detailed logs: $log_file"
}

# Run main function
main "$@"
