#!/bin/bash
#
PATTERN="ibm-licens"

echo "=== AUDIT: All RBAC resources with '$PATTERN' in name (case-insensitive) ==="

# Helper: check if name contains pattern (case-insensitive)
matches_pattern() {
    echo "$1" | grep -iq "$PATTERN"
}

# ---- 1. ClusterRoles ----
echo ""
echo "[1] Matching ClusterRoles:"
oc get clusterroles -o name | while read cr; do
    name=$(basename "$cr")
    if matches_pattern "$name"; then
        echo "  $name"
    fi
done

# ---- 2. ClusterRoleBindings referencing matching roles ----
echo ""
echo "[2] Active ClusterRoleBindings to matching roles:"
oc get clusterrolebindings -o custom-columns="NAME:.metadata.name,ROLE:.roleRef.name" --no-headers | while read binding_name role_name; do
    if matches_pattern "$role_name"; then
        subjects=$(oc get clusterrolebinding "$binding_name" -o jsonpath='{range .subjects[*]}{.kind}:{.name}{" "}{end}' 2>/dev/null)
        echo "  Binding: $binding_name -> Role: $role_name | Subjects: $subjects"
    fi
done

# ---- 3. Namespace Roles (all namespaces) ----
echo ""
echo "[3] Matching namespace-scoped Roles:"
oc get roles -A -o custom-columns="NS:.metadata.namespace,NAME:.metadata.name" --no-headers | while read ns role_name; do
    if matches_pattern "$role_name"; then
        echo "  $ns/$role_name"
    fi
done

# ---- 4. RoleBindings referencing matching roles ----
echo ""
echo "[4] Active RoleBindings to matching roles:"
oc get rolebindings -A -o custom-columns="NS:.metadata.namespace,NAME:.metadata.name,ROLE:.roleRef.name" --no-headers | while read ns binding_name role_name; do
    if matches_pattern "$role_name"; then
        subjects=$(oc get rolebinding -n "$ns" "$binding_name" -o jsonpath='{range .subjects[*]}{.kind}:{.name}{" "}{end}' 2>/dev/null)
        echo "  Binding: $ns/$binding_name -> Role: $role_name | Subjects: $subjects"
    fi
done

echo ""
echo "=== END ==="
echo "Note: This includes ALL roles/bindings with 'ibm-licens' in the name,"
echo "whether they end in -admin, -edit, -view, or have no suffix."


========

#!/bin/bash
#
echo "Checking dangerous ClusterRoles (licensing-related with -admin or -edit)..."

oc get clusterroles -o name | grep -E 'licensing|ibm.*license' | while read cr; do
  name=$(basename "$cr")
  if [[ "$name" == *"-admin"* || "$name" == *"-edit"* ]]; then
    echo "DANGEROUS ClusterRole: $name"
    # Check if bound
    if oc get clusterrolebinding -o json | jq -r '.items[] | select(.roleRef.name == "'"$name"'") | .metadata.name' | grep -q .; then
      echo "   BOUND! Run: oc get clusterrolebinding -o wide | grep '$name'"
    else
      echo "   Not bound -- safe to delete"
    fi
  fi
done

echo ""
echo "Checking active risky ClusterRoleBindings..."

oc get clusterrolebindings -o name | while read crb; do
  name=$(basename "$crb")
  role=$(oc get "$crb" -o jsonpath='{.roleRef.name}' 2>/dev/null)
  if [[ "$role" == *"licensing"* ]] && [[ "$role" == *"-admin"* || "$role" == *"-edit"* ]]; then
    echo "RISKY ClusterRoleBinding: $name -> Role: $role"
    echo "   Subjects: $(oc get "$crb" -o jsonpath='{range .subjects[*]}{.kind}:{.name} {.namespace}{" | "}{end}')"
  fi
done

echo ""
echo "Checking dangerous namespace Roles..."

oc get roles -A -o custom-columns="NS:.metadata.namespace,NAME:.metadata.name" --no-headers | while read ns name; do
  if [[ "$name" == *"licensing"* ]] && [[ "$name" == *"-admin"* || "$name" == *"-edit"* ]]; then
    echo "DANGEROUS Role: $ns/$name"
    if oc get rolebinding -n "$ns" -o json | jq -r '.items[] | select(.roleRef.name == "'"$name"'") | .metadata.name' | grep -q .; then
      echo "   Bound in namespace $ns"
    else
      echo "   Not bound in $ns"
    fi
  fi
done

echo ""
echo "Checking active risky RoleBindings..."

oc get rolebindings -A -o custom-columns="NS:.metadata.namespace,NAME:.metadata.name,ROLE:.roleRef.name" --no-headers | while read ns name role; do
  if [[ "$role" == *"licensing"* ]] && [[ "$role" == *"-admin"* || "$role" == *"-edit"* ]]; then
    echo "RISKY RoleBinding: $ns/$name -> Role: $role"
    echo "   Subjects: $(oc get rolebinding -n "$ns" "$name" -o jsonpath='{range .subjects[*]}{.kind}:{.name}{" | "}{end}')"
  fi
done

-------
oc get clusterrole,clusterrolebinding,role,rolebinding -A -o json | \
jq -r '
  # Define dangerous role name patterns
  def is_dangerous_role($name):
    ($name | endswith("-admin")) or
    ($name | endswith("-edit")) or
    ($name | test("ibm.*licensing.*admin"; "i")) or
    ($name | test("ibm.*licensing.*edit"; "i"));

  # Find all roles (ClusterRole + Role) that match dangerous pattern
  (.items[] | select(.kind == "ClusterRole" or .kind == "Role")) as $role |
  select(is_dangerous_role($role.metadata.name)) |
  "\($role.kind): \($role.metadata.namespace // "cluster")/\($role.metadata.name)" |
  @text,

  # Now find any bindings (ClusterRoleBinding or RoleBinding) that reference ANY licensing-related role
  (.items[] | select(.kind == "ClusterRoleBinding" or .kind == "RoleBinding")) as $binding |
  ($binding.roleRef.name // "") as $rolename |
  select(
    ($rolename | contains("licensing")) and
    (
      ($rolename | endswith("-admin")) or
      ($rolename | endswith("-edit")) or
      ($rolename | startswith("ibm-licensing")) or
      ($rolename | startswith("ibmlicensing"))
    )
  ) |
  "\($binding.kind): \($binding.metadata.namespace // "cluster")/\($binding.metadata.name) â†’ Role: \($rolename)" |
  @text
' | sort -u
