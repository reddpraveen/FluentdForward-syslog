apiVersion: batch/v1
kind: CronJob
metadata:
  name: cm-secret-pruner
  namespace: openshift-operators
spec:
  schedule: "34 19 * * *"  # Daily at 7:34 PM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        spec:
          serviceAccountName: cm-secret-pruner
          restartPolicy: Never  # Changed from OnFailure to Never
          containers:
          - name: pruner
            image: registry.redhat.io/openshift4/ose-cli:v4.16
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
            command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              
              # Enable debug mode to see each command - ENABLED FOR ENHANCED DEBUGGING
              set -x
              
              # Enhanced logging function
              log() {
                level="$1"
                shift
                echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $*" >&2
              }
              
              # Error handler with call stack
              error_exit() {
                log ERROR "$1"
                log ERROR "Call stack (most recent call last):"
                for ((i=${#BASH_SOURCE[@]}-1; i>=1; i--)); do
                  log ERROR "  ${BASH_SOURCE[$i]}:${BASH_LINENO[$i-1]} in \`${BASH_FUNCNAME[$i]}\`"
                done
                log ERROR "Current function: ${BASH_FUNCNAME[0]} at line ${BASH_LINENO[0]}"
                exit 1
              }
              
              # Trap errors with more details
              trap 'error_exit "Script failed at line $LINENO with exit code $?. Check logs above for details."' ERR
              
              # Function to safely run oc commands and capture output/error
              run_oc_command() {
                local command="$1"
                local description="$2"
                local output
                local exit_code
                
                log INFO "Executing: $description"
                log DEBUG "OC Command: $command"
                
                output=$(eval "$command" 2>&1)
                exit_code=$?
                
                if [ $exit_code -ne 0 ]; then
                  log ERROR "Command failed: $description"
                  log ERROR "Command: $command"
                  log ERROR "Exit Code: $exit_code"
                  log ERROR "Error Output: $output"
                  return $exit_code
                else
                  log DEBUG "Command output: $output"
                  echo "$output" # Return the output
                fi
              }
              
              # Function to safely run jq on JSON
              safe_jsonpath() {
                local json_string="$1"
                local jq_filter="$2"
                local description="$3"
                local result
                local exit_code

                log DEBUG "Applying jq filter '$jq_filter' for: $description"
                result=$(echo "$json_string" | jq -r "$jq_filter" 2>&1)
                exit_code=$?

                if [ $exit_code -ne 0 ]; then
                    log ERROR "jq command failed for: $description"
                    log ERROR "jq filter: $jq_filter"
                    log ERROR "Input JSON (first 500 chars): ${json_string:0:500}..."
                    log ERROR "jq error: $result"
                    return $exit_code
                fi

                # Check if jq returned "null" explicitly and handle it
                if [ "$result" = "null" ]; then
                    log DEBUG "jq filter '$jq_filter' returned null for: $description"
                    result=""
                fi

                echo "$result"
              }
              
              log INFO "========================================="
              log INFO "ConfigMap Pruner Job Started"
              log INFO "========================================="
              
              NS="openshift-operators"
              CM="cm-secret-pruner-config"
              
              # Verify we can access the cluster
              log INFO "Verifying cluster access..."
              run_oc_command "oc whoami" "Authenticate and get current user"
              CURRENT_USER=$(run_oc_command "oc whoami" "Get current user")
              log INFO "Authenticated as: $CURRENT_USER"
              
              # Verify ConfigMap exists
              log INFO "Looking for ConfigMap: $CM in namespace $NS"
              run_oc_command "oc -n '$NS' get cm '$CM'" "Check existence of ConfigMap $CM in $NS"
              log INFO "ConfigMap found: $CM in namespace $NS"
              
              # Load configuration with validation and proper defaults
              DRY_RUN_RAW=$(run_oc_command "oc -n '$NS' get cm '$CM' -o jsonpath='{.data.dryRun}' 2>/dev/null || echo 'NOT_FOUND'" "Get data.dryRun from ConfigMap $CM in $NS")
              if [ "$DRY_RUN_RAW" = "NOT_FOUND" ]; then
                  log WARN "data.dryRun not found in ConfigMap, using default 'true'"
                  DRY_RUN="true"
              else
                  DRY_RUN="$DRY_RUN_RAW"
              fi
              
              MIN_AGE_DAYS_RAW=$(run_oc_command "oc -n '$NS' get cm '$CM' -o jsonpath='{.data.minAgeDays}' 2>/dev/null || echo 'NOT_FOUND'" "Get data.minAgeDays from ConfigMap $CM in $NS")
              if [ "$MIN_AGE_DAYS_RAW" = "NOT_FOUND" ]; then
                  log WARN "data.minAgeDays not found in ConfigMap, using default '30'"
                  MIN_AGE_DAYS="30"
              else
                  MIN_AGE_DAYS="$MIN_AGE_DAYS_RAW"
              fi
              
              # Load excluded namespaces with fallback
              EXCLUDED_NS_RAW=$(run_oc_command "oc -n '$NS' get cm '$CM' -o jsonpath='{.data.excludedNamespaces}' 2>/dev/null || echo 'NOT_FOUND'" "Get data.excludedNamespaces from ConfigMap $CM in $NS")
              if [ "$EXCLUDED_NS_RAW" = "NOT_FOUND" ]; then
                log WARN "excludedNamespaces not found in ConfigMap, using defaults"
                EXCLUDED_NS=$(printf '^openshift-.*\n^kube-.*\n^default$\n^openshift$')
              else
                EXCLUDED_NS="$EXCLUDED_NS_RAW"
              fi
              
              # Load protected labels with fallback
              PROTECTED_LABELS_RAW=$(run_oc_command "oc -n '$NS' get cm '$CM' -o jsonpath='{.data.protectedLabels}' 2>/dev/null || echo 'NOT_FOUND'" "Get data.protectedLabels from ConfigMap $CM in $NS")
              if [ "$PROTECTED_LABELS_RAW" = "NOT_FOUND" ]; then
                log WARN "protectedLabels not found in ConfigMap, using defaults"
                PROTECTED_LABELS=$(printf 'app.kubernetes.io/managed-by=argocd\nmeta.helm.sh/release-name\nprune.protected=true')
              else
                PROTECTED_LABELS="$PROTECTED_LABELS_RAW"
              fi
              
              # Trim any trailing/leading whitespace and empty lines
              EXCLUDED_NS=$(echo "$EXCLUDED_NS" | sed '/^[[:space:]]*$/d')
              PROTECTED_LABELS=$(echo "$PROTECTED_LABELS" | sed '/^[[:space:]]*$/d')
              
              # Validate configuration
              if [[ ! "$MIN_AGE_DAYS" =~ ^[0-9]+$ ]]; then
                error_exit "Invalid minAgeDays value: $MIN_AGE_DAYS (must be a number)"
              fi
              
              log INFO "Configuration loaded successfully:"
              log INFO "  DRY_RUN: $DRY_RUN"
              log INFO "  MIN_AGE_DAYS: $MIN_AGE_DAYS"
              
              # Debug: Show excluded namespace patterns
              excluded_count=$(echo "$EXCLUDED_NS" | grep -c "^" || echo "0")
              log INFO "  EXCLUDED_NS patterns ($excluded_count):"
              while IFS= read -r pattern; do
                [[ -n "$pattern" ]] && log INFO "    - $pattern"
              done <<< "$EXCLUDED_NS"
              
              # Debug: Show protected labels
              label_count=$(echo "$PROTECTED_LABELS" | grep -c "^" || echo "0")
              log INFO "  PROTECTED_LABELS ($label_count):"
              while IFS= read -r label; do
                [[ -n "$label" ]] && log INFO "    - $label"
              done <<< "$PROTECTED_LABELS"
              
              log INFO "========================================="
              
              # Verify oc command works and we can list namespaces
              log INFO "Verifying RBAC permissions..."
              run_oc_command "oc get ns --no-headers" "List namespaces to verify permissions"
              
              # Get list of namespaces
              log INFO "Fetching namespace list..."
              namespace_list_raw=$(run_oc_command "oc get ns --no-headers -o custom-columns=':metadata.name'" "Get list of all namespaces")
              # Check if namespace_list_raw is empty *after* the command succeeds
              if [[ -z "$namespace_list_raw" ]]; then
                error_exit "No namespaces found using 'oc get ns' after command succeeded - this is unexpected."
              fi
              # Convert raw list to array, handling potential empty lines
              IFS=$'\n' read -rd '' -a namespace_list <<< "$namespace_list_raw" || true
              
              namespace_count=${#namespace_list[@]}
              log INFO "Found $namespace_count total namespaces in cluster"
              
              total_deleted=0
              total_skipped=0
              total_protected=0
              total_too_new=0
              total_referenced=0
              total_errors=0
              namespaces_processed=0
              namespaces_excluded=0
              
              for ns in "${namespace_list[@]}"; do
                # Check for empty elements from IFS split
                [[ -z "$ns" ]] && continue 
                
                log DEBUG "Checking namespace: $ns"
                
                # Check if namespace is excluded
                excluded=false
                matched_pattern=""
                while IFS= read -r pattern; do
                  [[ -z "$pattern" ]] && continue
                  if echo "$ns" | grep -Eq "$pattern" 2>/dev/null; then
                    excluded=true
                    matched_pattern="$pattern"
                    break
                  fi
                done <<< "$EXCLUDED_NS"
                
                if [[ "$excluded" == "true" ]]; then
                  log DEBUG "Skipping excluded namespace: $ns (pattern: $matched_pattern)"
                  namespaces_excluded=$((namespaces_excluded + 1))
                  continue
                fi
                
                namespaces_processed=$((namespaces_processed + 1))
                log INFO "========================================="
                log INFO "Processing namespace [$namespaces_processed]: $ns"
                log INFO "========================================="
                
                # Get ConfigMaps in namespace
                cm_list_raw=$(run_oc_command "oc get cm -n '$ns' --no-headers -o custom-columns=':metadata.name' 2>/dev/null || echo 'CM_ERROR'" "List ConfigMaps in namespace $ns")
                if [ "$cm_list_raw" = "CM_ERROR" ]; then
                  log WARN "Unable to list ConfigMaps in namespace: $ns (permission denied or error)"
                  total_errors=$((total_errors + 1))
                  continue
                fi
                # Convert raw list to array
                IFS=$'\n' read -rd '' -a cm_list_array <<< "$cm_list_raw" || true
                
                if [[ ${#cm_list_array[@]} -eq 1 && -z "${cm_list_array[0]}" ]]; then
                  log INFO "No ConfigMaps found in namespace: $ns"
                  continue
                fi
                
                cm_count=${#cm_list_array[@]}
                log INFO "Found $cm_count ConfigMap(s) in namespace: $ns"
                
                deleted_in_ns=0
                skipped_in_ns=0
                
                for cm_name_full in "${cm_list_array[@]}"; do
                  # Check for empty elements from IFS split
                  [[ -z "$cm_name_full" ]] && continue 
                  name=$(echo "$cm_name_full" | cut -d'/' -f2)
                  
                  log DEBUG "Evaluating ConfigMap: $name in namespace: $ns"
                  
                  # Get ConfigMap metadata (using JSON for reliability)
                  cm_json_raw=$(run_oc_command "oc get cm '$name' -n '$ns' -o json 2>/dev/null || echo 'CM_JSON_ERROR'" "Get ConfigMap $name details in $ns")
                  if [ "$cm_json_raw" = "CM_JSON_ERROR" ]; then
                    log WARN "Unable to get ConfigMap details: $name in $ns (skipping)"
                    skipped_in_ns=$((skipped_in_ns + 1))
                    total_errors=$((total_errors + 1))
                    continue
                  fi
                  
                  # Check for protected labels
                  skip=false
                  protected_by=""
                  while IFS= read -r label_rule; do
                    [[ -z "$label_rule" ]] && continue
                    
                    if [[ "$label_rule" == *"="* ]]; then
                      # Key=value format (e.g., "app.kubernetes.io/managed-by=argocd")
                      key="${label_rule%=*}"
                      value="${label_rule#*=}"
                      # Use safe_jsonpath function
                      actual_value=$(safe_jsonpath "$cm_json_raw" ".metadata.labels.\"${key}\" // empty" "Get label value for $key in $name/$ns")
                      
                      if [[ -n "$actual_value" && "$actual_value" == "$value" ]]; then
                        log INFO "PROTECTED: ConfigMap has label [$key=$value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        total_protected=$((total_protected + 1))
                        break
                      fi
                    else
                      # Key-only format (e.g., "prune.protected")
                      # Use safe_jsonpath to check existence
                      safe_jsonpath "$cm_json_raw" ".metadata.labels.\"${label_rule}\"" "Check label existence $label_rule in $name/$ns" >/dev/null 2>&1
                      if [ $? -eq 0 ]; then
                        # Get the value for logging
                        actual_value=$(safe_jsonpath "$cm_json_raw" ".metadata.labels.\"${label_rule}\" // empty" "Get label value for $label_rule in $name/$ns")
                        log INFO "PROTECTED: ConfigMap has label [$label_rule=$actual_value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        total_protected=$((total_protected + 1))
                        break
                      fi
                    fi
                  done <<< "$PROTECTED_LABELS"
                  
                  if [[ "$skip" == "true" ]]; then
                    skipped_in_ns=$((skipped_in_ns + 1))
                    continue
                  fi
                  
                  # Check age (only if MIN_AGE_DAYS > 0)
                  if [[ "$MIN_AGE_DAYS" -gt 0 ]]; then
                    created=$(safe_jsonpath "$cm_json_raw" ".metadata.creationTimestamp" "Get creation timestamp for $name/$ns")
                    if [[ -n "$created" ]]; then # safe_jsonpath returns empty if null or missing
                      if created_epoch=$(date -d "$created" +%s 2>/dev/null); then
                        current_epoch=$(date +%s)
                        age_days=$(( (current_epoch - created_epoch) / 86400 ))
                        
                        if [[ "$age_days" -lt "$MIN_AGE_DAYS" ]]; then
                          log INFO "TOO NEW: ConfigMap is $age_days days old (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                          skipped_in_ns=$((skipped_in_ns + 1))
                          total_too_new=$((total_too_new + 1))
                          continue
                        fi
                        log DEBUG "ConfigMap age: $age_days days (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                      else
                        log WARN "Unable to parse creation timestamp '$created' for ConfigMap: $name in $ns"
                      fi
                    else
                      log WARN "Creation timestamp not found for ConfigMap: $name in $ns. Assuming old enough."
                    fi
                  fi
                  
                  # Check if referenced by any workload
                  log DEBUG "Checking workload references - namespace=$ns name=$name"
                  referenced=false
                  
                  # Get all workloads that might reference ConfigMaps
                  workloads_raw=$(run_oc_command "oc get pod,deploy,deployment,ds,daemonset,sts,statefulset,job,cronjob,rs,replicaset -n '$ns' -o yaml 2>/dev/null || echo 'WL_ERROR'" "Get YAML of all workloads in $ns for reference check")
                  if [ "$workloads_raw" != "WL_ERROR" ]; then
                    # Check for configMap name references in volumes or envFrom
                    if echo "$workloads_raw" | grep -E "(configMap:|configMapRef:|configMapKeyRef:)" -A 2 | grep -q "name: $name"; then
                      log INFO "REFERENCED: ConfigMap is in use by workload - namespace=$ns name=$name"
                      referenced=true
                      total_referenced=$((total_referenced + 1))
                    fi
                  else
                    log WARN "Unable to check workload references in namespace: $ns (assuming ConfigMap is safe to delete)"
                  fi
                  
                  if [[ "$referenced" == "true" ]]; then
                    skipped_in_ns=$((skipped_in_ns + 1))
                    continue
                  fi
                  
                  # DELETE or DRY RUN
                  if [[ "$DRY_RUN" == "false" ]]; then
                    log WARN "DELETING: Unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    if run_oc_command "oc delete cm '$name' -n '$ns'" "Delete ConfigMap $name in $ns"; then
                      deleted_in_ns=$((deleted_in_ns + 1))
                      total_deleted=$((total_deleted + 1))
                      log INFO "Successfully deleted ConfigMap - namespace=$ns name=$name"
                    else
                      log ERROR "Failed to delete ConfigMap - namespace=$ns name=$name"
                      skipped_in_ns=$((skipped_in_ns + 1))
                      total_errors=$((total_errors + 1))
                    fi
                  else
                    log INFO "DRY-RUN: Would delete unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    deleted_in_ns=$((deleted_in_ns + 1)) # Increment for summary
                    total_deleted=$((total_deleted + 1))  # Increment for summary
                  fi
                  
                done # End loop over ConfigMaps in namespace
                log INFO "Namespace summary - namespace=$ns deleted=$deleted_in_ns skipped=$skipped_in_ns"
                total_skipped=$((total_skipped + skipped_in_ns))
                
              done # End loop over namespaces
              
              log INFO "========================================="
              log INFO "Job Completed Successfully"
              log INFO "========================================="
              log INFO "Summary Statistics:"
              log INFO "  Total namespaces in cluster: $namespace_count"
              log INFO "  Namespaces excluded: $namespaces_excluded"
              log INFO "  Namespaces processed: $namespaces_processed"
              log INFO "  ConfigMaps deleted/would delete: $total_deleted"
              log INFO "  ConfigMaps skipped: $total_skipped"
              log INFO "    - Protected by labels: $total_protected"
              log INFO "    - Too new (< $MIN_AGE_DAYS days): $total_too_new"
              log INFO "    - Referenced by workloads: $total_referenced"
              log INFO "  Errors encountered: $total_errors"
              log INFO "  Dry run mode: $DRY_RUN"
              log INFO "========================================="
              
              exit 0
            volumeMounts:
            - name: logs
              mountPath: /logs
          volumes:
          - name: logs
            emptyDir: {}


====================
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cm-secret-pruner
  namespace: openshift-operators
spec:
  schedule: "34 19 * * *"  # Daily at 7:34 PM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        spec:
          serviceAccountName: cm-secret-pruner
          restartPolicy: Never  # Changed from OnFailure to Never
          containers:
          - name: pruner
            image: registry.redhat.io/openshift4/ose-cli:v4.16
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
            command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              
              # Enable debug mode to see each command
              # Uncomment the next line for detailed debugging
              # set -x
              
              # Enhanced logging with color support
              log() {
                level="$1"
                shift
                echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $*"
              }
              
              # Error handler
              error_exit() {
                log ERROR "$1"
                exit 1
              }
              
              # Trap errors with more details
              trap 'echo "[ERROR] Script failed at line $LINENO with exit code $?"; exit 1' ERR
              
              log INFO "========================================="
              log INFO "ConfigMap Pruner Job Started"
              log INFO "========================================="
              
              NS="openshift-operators"
              CM="cm-secret-pruner-config"
              
              # Verify we can access the cluster
              log INFO "Verifying cluster access..."
              if ! oc whoami &>/dev/null; then
                error_exit "Unable to authenticate with OpenShift cluster"
              fi
              log INFO "Authenticated as: $(oc whoami)"
              
              # Verify ConfigMap exists
              log INFO "Looking for ConfigMap: $CM in namespace $NS"
              if ! oc -n "$NS" get cm "$CM" &>/dev/null; then
                error_exit "ConfigMap $CM not found in namespace $NS"
              fi
              log INFO "ConfigMap found: $CM in namespace $NS"
              
              # Load configuration with validation and proper defaults
              DRY_RUN=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.dryRun}' 2>/dev/null)
              [[ -z "$DRY_RUN" ]] && DRY_RUN="true"
              
              MIN_AGE_DAYS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.minAgeDays}' 2>/dev/null)
              [[ -z "$MIN_AGE_DAYS" ]] && MIN_AGE_DAYS="30"
              
              # Load excluded namespaces with fallback
              EXCLUDED_NS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.excludedNamespaces}' 2>/dev/null)
              if [[ -z "$EXCLUDED_NS" ]]; then
                log WARN "excludedNamespaces not found in ConfigMap, using defaults"
                EXCLUDED_NS=$(printf '^openshift-.*\n^kube-.*\n^default$\n^openshift$')
              fi
              
              # Load protected labels with fallback
              PROTECTED_LABELS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.protectedLabels}' 2>/dev/null)
              if [[ -z "$PROTECTED_LABELS" ]]; then
                log WARN "protectedLabels not found in ConfigMap, using defaults"
                PROTECTED_LABELS=$(printf 'app.kubernetes.io/managed-by=argocd\nmeta.helm.sh/release-name\nprune.protected=true')
              fi
              
              # Trim any trailing/leading whitespace and empty lines
              EXCLUDED_NS=$(echo "$EXCLUDED_NS" | sed '/^[[:space:]]*$/d')
              PROTECTED_LABELS=$(echo "$PROTECTED_LABELS" | sed '/^[[:space:]]*$/d')
              
              # Validate configuration
              if [[ ! "$MIN_AGE_DAYS" =~ ^[0-9]+$ ]]; then
                error_exit "Invalid minAgeDays value: $MIN_AGE_DAYS (must be a number)"
              fi
              
              log INFO "Configuration loaded successfully:"
              log INFO "  DRY_RUN: $DRY_RUN"
              log INFO "  MIN_AGE_DAYS: $MIN_AGE_DAYS"
              
              # Debug: Show excluded namespace patterns
              excluded_count=$(echo "$EXCLUDED_NS" | grep -c "^" || echo "0")
              log INFO "  EXCLUDED_NS patterns ($excluded_count):"
              while IFS= read -r pattern; do
                [[ -n "$pattern" ]] && log INFO "    - $pattern"
              done <<< "$EXCLUDED_NS"
              
              # Debug: Show protected labels
              label_count=$(echo "$PROTECTED_LABELS" | grep -c "^" || echo "0")
              log INFO "  PROTECTED_LABELS ($label_count):"
              while IFS= read -r label; do
                [[ -n "$label" ]] && log INFO "    - $label"
              done <<< "$PROTECTED_LABELS"
              
              log INFO "========================================="
              
              # Verify oc command works and we can list namespaces
              log INFO "Verifying RBAC permissions..."
              if ! oc get ns &>/dev/null; then
                error_exit "Unable to list namespaces - check ClusterRole permissions for ServiceAccount"
              fi
              
              # Get list of namespaces
              log INFO "Fetching namespace list..."
              namespace_list=$(oc get ns -o name 2>/dev/null | cut -d'/' -f2)
              if [[ -z "$namespace_list" ]]; then
                error_exit "No namespaces found - this is unexpected"
              fi
              
              namespace_count=$(echo "$namespace_list" | wc -l)
              log INFO "Found $namespace_count total namespaces in cluster"
              
              total_deleted=0
              total_skipped=0
              total_protected=0
              total_too_new=0
              total_referenced=0
              total_errors=0
              namespaces_processed=0
              namespaces_excluded=0
              
              while IFS= read -r ns; do
                [[ -z "$ns" ]] && continue
                
                log DEBUG "Checking namespace: $ns"
                
                # Check if namespace is excluded
                excluded=false
                matched_pattern=""
                while IFS= read -r pattern; do
                  [[ -z "$pattern" ]] && continue
                  if echo "$ns" | grep -Eq "$pattern" 2>/dev/null; then
                    excluded=true
                    matched_pattern="$pattern"
                    break
                  fi
                done <<< "$EXCLUDED_NS"
                
                if [[ "$excluded" == "true" ]]; then
                  log DEBUG "Skipping excluded namespace: $ns (pattern: $matched_pattern)"
                  namespaces_excluded=$((namespaces_excluded + 1))
                  continue
                fi
                
                namespaces_processed=$((namespaces_processed + 1))
                log INFO "========================================="
                log INFO "Processing namespace [$namespaces_processed]: $ns"
                log INFO "========================================="
                
                # Get ConfigMaps in namespace
                if ! cm_list=$(oc get cm -n "$ns" -o name 2>/dev/null); then
                  log WARN "Unable to list ConfigMaps in namespace: $ns (permission denied or error)"
                  ((total_errors++))
                  continue
                fi
                
                if [[ -z "$cm_list" ]]; then
                  log INFO "No ConfigMaps found in namespace: $ns"
                  continue
                fi
                
                cm_count=$(echo "$cm_list" | wc -l)
                log INFO "Found $cm_count ConfigMap(s) in namespace: $ns"
                
                deleted_in_ns=0
                skipped_in_ns=0
                
                while IFS= read -r cm_name_full; do
                  [[ -z "$cm_name_full" ]] && continue
                  name=$(echo "$cm_name_full" | cut -d'/' -f2)
                  
                  log DEBUG "Evaluating ConfigMap: $name in namespace: $ns"
                  
                  # Get ConfigMap metadata (using JSON for reliability)
                  if ! cm_json=$(oc get cm "$name" -n "$ns" -o json 2>/dev/null); then
                    log WARN "Unable to get ConfigMap details: $name in $ns (skipping)"
                    ((skipped_in_ns++))
                    ((total_errors++))
                    continue
                  fi
                  
                  # Check for protected labels
                  skip=false
                  protected_by=""
                  while IFS= read -r label_rule; do
                    [[ -z "$label_rule" ]] && continue
                    
                    if [[ "$label_rule" == *"="* ]]; then
                      # Key=value format (e.g., "app.kubernetes.io/managed-by=argocd")
                      key="${label_rule%=*}"
                      value="${label_rule#*=}"
                      actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"${key}\" // empty" 2>/dev/null || echo "")
                      
                      if [[ -n "$actual_value" && "$actual_value" == "$value" ]]; then
                        log INFO "PROTECTED: ConfigMap has label [$key=$value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        ((total_protected++))
                        break
                      fi
                    else
                      # Key-only format (e.g., "prune.protected")
                      if echo "$cm_json" | jq -e ".metadata.labels.\"${label_rule}\"" &>/dev/null; then
                        actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"${label_rule}\"" 2>/dev/null)
                        log INFO "PROTECTED: ConfigMap has label [$label_rule=$actual_value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        ((total_protected++))
                        break
                      fi
                    fi
                  done <<< "$PROTECTED_LABELS"
                  
                  if [[ "$skip" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # Check age (only if MIN_AGE_DAYS > 0)
                  if [[ "$MIN_AGE_DAYS" -gt 0 ]]; then
                    created=$(echo "$cm_json" | jq -r '.metadata.creationTimestamp' 2>/dev/null || echo "")
                    if [[ -n "$created" && "$created" != "null" ]]; then
                      if created_epoch=$(date -d "$created" +%s 2>/dev/null); then
                        current_epoch=$(date +%s)
                        age_days=$(( (current_epoch - created_epoch) / 86400 ))
                        
                        if [[ "$age_days" -lt "$MIN_AGE_DAYS" ]]; then
                          log INFO "TOO NEW: ConfigMap is $age_days days old (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                          ((skipped_in_ns++))
                          ((total_too_new++))
                          continue
                        fi
                        log DEBUG "ConfigMap age: $age_days days (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                      else
                        log WARN "Unable to parse creation timestamp for ConfigMap: $name in $ns"
                      fi
                    fi
                  fi
                  
                  # Check if referenced by any workload
                  log DEBUG "Checking workload references - namespace=$ns name=$name"
                  referenced=false
                  
                  # Get all workloads that might reference ConfigMaps
                  if workloads=$(oc get pod,deploy,deployment,ds,daemonset,sts,statefulset,job,cronjob,rs,replicaset -n "$ns" -o yaml 2>/dev/null); then
                    # Check for configMap name references in volumes or envFrom
                    # This checks for:
                    # - volumes.configMap.name: <name>
                    # - envFrom.configMapRef.name: <name>
                    # - env.valueFrom.configMapKeyRef.name: <name>
                    if echo "$workloads" | grep -E "(configMap:|configMapRef:|configMapKeyRef:)" -A 2 | grep -q "name: $name"; then
                      log INFO "REFERENCED: ConfigMap is in use by workload - namespace=$ns name=$name"
                      referenced=true
                      ((total_referenced++))
                    fi
                  else
                    log WARN "Unable to check workload references in namespace: $ns (assuming ConfigMap is safe to delete)"
                  fi
                  
                  if [[ "$referenced" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # DELETE or DRY RUN
                  if [[ "$DRY_RUN" == "false" ]]; then
                    log WARN "DELETING: Unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    if oc delete cm "$name" -n "$ns" 2>&1; then
                      ((deleted_in_ns++))
                      ((total_deleted++))
                      log INFO "Successfully deleted ConfigMap - namespace=$ns name=$name"
                    else
                      log ERROR "Failed to delete ConfigMap - namespace=$ns name=$name"
                      ((skipped_in_ns++))
                      ((total_errors++))
                    fi
                  else
                    log INFO "DRY-RUN: Would delete unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    ((deleted_in_ns++))
                    ((total_deleted++))
                  fi
                  
                done <<< "$cm_list"
                
                log INFO "Namespace summary - namespace=$ns deleted=$deleted_in_ns skipped=$skipped_in_ns"
                ((total_skipped += skipped_in_ns))
                
              done <<< "$namespace_list"
              
              log INFO "========================================="
              log INFO "Job Completed Successfully"
              log INFO "========================================="
              log INFO "Summary Statistics:"
              log INFO "  Total namespaces in cluster: $namespace_count"
              log INFO "  Namespaces excluded: $namespaces_excluded"
              log INFO "  Namespaces processed: $namespaces_processed"
              log INFO "  ConfigMaps deleted/would delete: $total_deleted"
              log INFO "  ConfigMaps skipped: $total_skipped"
              log INFO "    - Protected by labels: $total_protected"
              log INFO "    - Too new (< $MIN_AGE_DAYS days): $total_too_new"
              log INFO "    - Referenced by workloads: $total_referenced"
              log INFO "  Errors encountered: $total_errors"
              log INFO "  Dry run mode: $DRY_RUN"
              log INFO "========================================="
              
              exit 0



---------------------
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cm-secret-pruner
  namespace: openshift-operators
spec:
  schedule: "34 19 * * *"  # Daily at 7:34 PM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        spec:
          serviceAccountName: cm-secret-pruner
          restartPolicy: Never  # Changed from OnFailure to Never
          containers:
          - name: pruner
            image: registry.redhat.io/openshift4/ose-cli:v4.16
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
            command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              
              # Enhanced logging with color support
              log() {
                level="$1"
                shift
                echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $*"
              }
              
              # Error handler
              error_exit() {
                log ERROR "$1"
                exit 1
              }
              
              # Trap errors
              trap 'error_exit "Script failed at line $LINENO"' ERR
              
              log INFO "========================================="
              log INFO "ConfigMap Pruner Job Started"
              log INFO "========================================="
              
              NS="openshift-operators"
              CM="cm-secret-pruner-config"
              
              # Verify we can access the cluster
              log INFO "Verifying cluster access..."
              if ! oc whoami &>/dev/null; then
                error_exit "Unable to authenticate with OpenShift cluster"
              fi
              log INFO "Authenticated as: $(oc whoami)"
              
              # Verify ConfigMap exists
              log INFO "Looking for ConfigMap: $CM in namespace $NS"
              if ! oc -n "$NS" get cm "$CM" &>/dev/null; then
                error_exit "ConfigMap $CM not found in namespace $NS"
              fi
              log INFO "ConfigMap found: $CM in namespace $NS"
              
              # Load configuration with validation and proper defaults
              DRY_RUN=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.dryRun}' 2>/dev/null)
              [[ -z "$DRY_RUN" ]] && DRY_RUN="true"
              
              MIN_AGE_DAYS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.minAgeDays}' 2>/dev/null)
              [[ -z "$MIN_AGE_DAYS" ]] && MIN_AGE_DAYS="30"
              
              # Load excluded namespaces with fallback
              EXCLUDED_NS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.excludedNamespaces}' 2>/dev/null)
              if [[ -z "$EXCLUDED_NS" ]]; then
                log WARN "excludedNamespaces not found in ConfigMap, using defaults"
                EXCLUDED_NS=$(printf '^openshift-.*\n^kube-.*\n^default$\n^openshift$')
              fi
              
              # Load protected labels with fallback
              PROTECTED_LABELS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.protectedLabels}' 2>/dev/null)
              if [[ -z "$PROTECTED_LABELS" ]]; then
                log WARN "protectedLabels not found in ConfigMap, using defaults"
                PROTECTED_LABELS=$(printf 'app.kubernetes.io/managed-by=argocd\nmeta.helm.sh/release-name\nprune.protected=true')
              fi
              
              # Trim any trailing/leading whitespace and empty lines
              EXCLUDED_NS=$(echo "$EXCLUDED_NS" | sed '/^[[:space:]]*$/d')
              PROTECTED_LABELS=$(echo "$PROTECTED_LABELS" | sed '/^[[:space:]]*$/d')
              
              # Validate configuration
              if [[ ! "$MIN_AGE_DAYS" =~ ^[0-9]+$ ]]; then
                error_exit "Invalid minAgeDays value: $MIN_AGE_DAYS (must be a number)"
              fi
              
              log INFO "Configuration loaded successfully:"
              log INFO "  DRY_RUN: $DRY_RUN"
              log INFO "  MIN_AGE_DAYS: $MIN_AGE_DAYS"
              
              # Debug: Show excluded namespace patterns
              excluded_count=$(echo "$EXCLUDED_NS" | grep -c "^" || echo "0")
              log INFO "  EXCLUDED_NS patterns ($excluded_count):"
              while IFS= read -r pattern; do
                [[ -n "$pattern" ]] && log INFO "    - $pattern"
              done <<< "$EXCLUDED_NS"
              
              # Debug: Show protected labels
              label_count=$(echo "$PROTECTED_LABELS" | grep -c "^" || echo "0")
              log INFO "  PROTECTED_LABELS ($label_count):"
              while IFS= read -r label; do
                [[ -n "$label" ]] && log INFO "    - $label"
              done <<< "$PROTECTED_LABELS"
              
              log INFO "========================================="
              
              # Verify oc command works and we can list namespaces
              log INFO "Verifying RBAC permissions..."
              if ! oc get ns &>/dev/null; then
                error_exit "Unable to list namespaces - check ClusterRole permissions for ServiceAccount"
              fi
              
              # Get list of namespaces
              log INFO "Fetching namespace list..."
              namespace_list=$(oc get ns -o name 2>/dev/null | cut -d'/' -f2)
              if [[ -z "$namespace_list" ]]; then
                error_exit "No namespaces found - this is unexpected"
              fi
              
              namespace_count=$(echo "$namespace_list" | wc -l)
              log INFO "Found $namespace_count total namespaces in cluster"
              
              total_deleted=0
              total_skipped=0
              total_protected=0
              total_too_new=0
              total_referenced=0
              total_errors=0
              namespaces_processed=0
              namespaces_excluded=0
              
              while IFS= read -r ns; do
                [[ -z "$ns" ]] && continue
                
                # Check if namespace is excluded
                excluded=false
                matched_pattern=""
                while IFS= read -r pattern; do
                  [[ -z "$pattern" ]] && continue
                  if echo "$ns" | grep -Eq "$pattern"; then
                    excluded=true
                    matched_pattern="$pattern"
                    break
                  fi
                done <<< "$EXCLUDED_NS"
                
                if [[ "$excluded" == "true" ]]; then
                  log DEBUG "Skipping excluded namespace: $ns (pattern: $matched_pattern)"
                  ((namespaces_excluded++))
                  continue
                fi
                
                ((namespaces_processed++))
                log INFO "========================================="
                log INFO "Processing namespace [$namespaces_processed]: $ns"
                log INFO "========================================="
                
                # Get ConfigMaps in namespace
                if ! cm_list=$(oc get cm -n "$ns" -o name 2>/dev/null); then
                  log WARN "Unable to list ConfigMaps in namespace: $ns (permission denied or error)"
                  ((total_errors++))
                  continue
                fi
                
                if [[ -z "$cm_list" ]]; then
                  log INFO "No ConfigMaps found in namespace: $ns"
                  continue
                fi
                
                cm_count=$(echo "$cm_list" | wc -l)
                log INFO "Found $cm_count ConfigMap(s) in namespace: $ns"
                
                deleted_in_ns=0
                skipped_in_ns=0
                
                while IFS= read -r cm_name_full; do
                  [[ -z "$cm_name_full" ]] && continue
                  name=$(echo "$cm_name_full" | cut -d'/' -f2)
                  
                  log DEBUG "Evaluating ConfigMap: $name in namespace: $ns"
                  
                  # Get ConfigMap metadata (using JSON for reliability)
                  if ! cm_json=$(oc get cm "$name" -n "$ns" -o json 2>/dev/null); then
                    log WARN "Unable to get ConfigMap details: $name in $ns (skipping)"
                    ((skipped_in_ns++))
                    ((total_errors++))
                    continue
                  fi
                  
                  # Check for protected labels
                  skip=false
                  protected_by=""
                  while IFS= read -r label_rule; do
                    [[ -z "$label_rule" ]] && continue
                    
                    if [[ "$label_rule" == *"="* ]]; then
                      # Key=value format (e.g., "app.kubernetes.io/managed-by=argocd")
                      key="${label_rule%=*}"
                      value="${label_rule#*=}"
                      actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"${key}\" // empty" 2>/dev/null || echo "")
                      
                      if [[ -n "$actual_value" && "$actual_value" == "$value" ]]; then
                        log INFO "PROTECTED: ConfigMap has label [$key=$value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        ((total_protected++))
                        break
                      fi
                    else
                      # Key-only format (e.g., "prune.protected")
                      if echo "$cm_json" | jq -e ".metadata.labels.\"${label_rule}\"" &>/dev/null; then
                        actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"${label_rule}\"" 2>/dev/null)
                        log INFO "PROTECTED: ConfigMap has label [$label_rule=$actual_value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        ((total_protected++))
                        break
                      fi
                    fi
                  done <<< "$PROTECTED_LABELS"
                  
                  if [[ "$skip" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # Check age (only if MIN_AGE_DAYS > 0)
                  if [[ "$MIN_AGE_DAYS" -gt 0 ]]; then
                    created=$(echo "$cm_json" | jq -r '.metadata.creationTimestamp' 2>/dev/null || echo "")
                    if [[ -n "$created" && "$created" != "null" ]]; then
                      if created_epoch=$(date -d "$created" +%s 2>/dev/null); then
                        current_epoch=$(date +%s)
                        age_days=$(( (current_epoch - created_epoch) / 86400 ))
                        
                        if [[ "$age_days" -lt "$MIN_AGE_DAYS" ]]; then
                          log INFO "TOO NEW: ConfigMap is $age_days days old (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                          ((skipped_in_ns++))
                          ((total_too_new++))
                          continue
                        fi
                        log DEBUG "ConfigMap age: $age_days days (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                      else
                        log WARN "Unable to parse creation timestamp for ConfigMap: $name in $ns"
                      fi
                    fi
                  fi
                  
                  # Check if referenced by any workload
                  log DEBUG "Checking workload references - namespace=$ns name=$name"
                  referenced=false
                  
                  # Get all workloads that might reference ConfigMaps
                  if workloads=$(oc get pod,deploy,deployment,ds,daemonset,sts,statefulset,job,cronjob,rs,replicaset -n "$ns" -o yaml 2>/dev/null); then
                    # Check for configMap name references in volumes or envFrom
                    # This checks for:
                    # - volumes.configMap.name: <name>
                    # - envFrom.configMapRef.name: <name>
                    # - env.valueFrom.configMapKeyRef.name: <name>
                    if echo "$workloads" | grep -E "(configMap:|configMapRef:|configMapKeyRef:)" -A 2 | grep -q "name: $name"; then
                      log INFO "REFERENCED: ConfigMap is in use by workload - namespace=$ns name=$name"
                      referenced=true
                      ((total_referenced++))
                    fi
                  else
                    log WARN "Unable to check workload references in namespace: $ns (assuming ConfigMap is safe to delete)"
                  fi
                  
                  if [[ "$referenced" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # DELETE or DRY RUN
                  if [[ "$DRY_RUN" == "false" ]]; then
                    log WARN "DELETING: Unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    if oc delete cm "$name" -n "$ns" 2>&1; then
                      ((deleted_in_ns++))
                      ((total_deleted++))
                      log INFO "Successfully deleted ConfigMap - namespace=$ns name=$name"
                    else
                      log ERROR "Failed to delete ConfigMap - namespace=$ns name=$name"
                      ((skipped_in_ns++))
                      ((total_errors++))
                    fi
                  else
                    log INFO "DRY-RUN: Would delete unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    ((deleted_in_ns++))
                    ((total_deleted++))
                  fi
                  
                done <<< "$cm_list"
                
                log INFO "Namespace summary - namespace=$ns deleted=$deleted_in_ns skipped=$skipped_in_ns"
                ((total_skipped += skipped_in_ns))
                
              done <<< "$namespace_list"
              
              log INFO "========================================="
              log INFO "Job Completed Successfully"
              log INFO "========================================="
              log INFO "Summary Statistics:"
              log INFO "  Total namespaces in cluster: $namespace_count"
              log INFO "  Namespaces excluded: $namespaces_excluded"
              log INFO "  Namespaces processed: $namespaces_processed"
              log INFO "  ConfigMaps deleted/would delete: $total_deleted"
              log INFO "  ConfigMaps skipped: $total_skipped"
              log INFO "    - Protected by labels: $total_protected"
              log INFO "    - Too new (< $MIN_AGE_DAYS days): $total_too_new"
              log INFO "    - Referenced by workloads: $total_referenced"
              log INFO "  Errors encountered: $total_errors"
              log INFO "  Dry run mode: $DRY_RUN"
              log INFO "========================================="
              
              exit 0
=====================================





apiVersion: batch/v1
kind: CronJob
metadata:
  name: cm-secret-pruner
  namespace: openshift-operators
spec:
  schedule: "34 19 * * *"  # Daily at 7:34 PM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        spec:
          serviceAccountName: cm-secret-pruner
          restartPolicy: Never  # Changed from OnFailure to Never
          containers:
          - name: pruner
            image: registry.redhat.io/openshift4/ose-cli:v4.16
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
            command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              
              # Enhanced logging with color support
              log() {
                level="$1"
                shift
                echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $*"
              }
              
              # Error handler
              error_exit() {
                log ERROR "$1"
                exit 1
              }
              
              # Trap errors
              trap 'error_exit "Script failed at line $LINENO"' ERR
              
              log INFO "========================================="
              log INFO "ConfigMap Pruner Job Started"
              log INFO "========================================="
              
              NS="openshift-operators"
              CM="cm-secret-pruner-config"
              
              # Verify we can access the cluster
              log INFO "Verifying cluster access..."
              if ! oc whoami &>/dev/null; then
                error_exit "Unable to authenticate with OpenShift cluster"
              fi
              log INFO "Authenticated as: $(oc whoami)"
              
              # Verify ConfigMap exists
              log INFO "Looking for ConfigMap: $CM in namespace $NS"
              if ! oc -n "$NS" get cm "$CM" &>/dev/null; then
                error_exit "ConfigMap $CM not found in namespace $NS"
              fi
              log INFO "ConfigMap found: $CM in namespace $NS"
              
              # Load configuration with validation and proper defaults
              DRY_RUN=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.dryRun}' 2>/dev/null)
              [[ -z "$DRY_RUN" ]] && DRY_RUN="true"
              
              MIN_AGE_DAYS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.minAgeDays}' 2>/dev/null)
              [[ -z "$MIN_AGE_DAYS" ]] && MIN_AGE_DAYS="30"
              
              # Load excluded namespaces with fallback
              EXCLUDED_NS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.excludedNamespaces}' 2>/dev/null)
              if [[ -z "$EXCLUDED_NS" ]]; then
                log WARN "excludedNamespaces not found in ConfigMap, using defaults"
                EXCLUDED_NS=$(printf '^openshift-.*\n^kube-.*\n^default$\n^openshift
              
              # Validate configuration
              if [[ ! "$MIN_AGE_DAYS" =~ ^[0-9]+$ ]]; then
                error_exit "Invalid minAgeDays value: $MIN_AGE_DAYS (must be a number)"
              fi
              
              log INFO "Configuration loaded successfully:"
              log INFO "  DRY_RUN: $DRY_RUN"
              log INFO "  MIN_AGE_DAYS: $MIN_AGE_DAYS"
              
              # Debug: Show excluded namespace patterns
              excluded_count=$(echo "$EXCLUDED_NS" | grep -c "^" || echo "0")
              log INFO "  EXCLUDED_NS patterns ($excluded_count):"
              while IFS= read -r pattern; do
                [[ -n "$pattern" ]] && log INFO "    - $pattern"
              done <<< "$EXCLUDED_NS"
              
              # Debug: Show protected labels
              label_count=$(echo "$PROTECTED_LABELS" | grep -c "^" || echo "0")
              log INFO "  PROTECTED_LABELS ($label_count):"
              while IFS= read -r label; do
                [[ -n "$label" ]] && log INFO "    - $label"
              done <<< "$PROTECTED_LABELS"
              
              log INFO "========================================="
              
              # Verify oc command works and we can list namespaces
              log INFO "Verifying RBAC permissions..."
              if ! oc get ns &>/dev/null; then
                error_exit "Unable to list namespaces - check ClusterRole permissions for ServiceAccount"
              fi
              
              # Get list of namespaces
              log INFO "Fetching namespace list..."
              namespace_list=$(oc get ns -o name 2>/dev/null | cut -d'/' -f2)
              if [[ -z "$namespace_list" ]]; then
                error_exit "No namespaces found - this is unexpected"
              fi
              
              namespace_count=$(echo "$namespace_list" | wc -l)
              log INFO "Found $namespace_count total namespaces in cluster"
              
              total_deleted=0
              total_skipped=0
              total_protected=0
              total_too_new=0
              total_referenced=0
              total_errors=0
              namespaces_processed=0
              namespaces_excluded=0
              
              while IFS= read -r ns; do
                [[ -z "$ns" ]] && continue
                
                # Check if namespace is excluded
                excluded=false
                matched_pattern=""
                while IFS= read -r pattern; do
                  [[ -z "$pattern" ]] && continue
                  if echo "$ns" | grep -Eq "$pattern"; then
                    excluded=true
                    matched_pattern="$pattern"
                    break
                  fi
                done <<< "$EXCLUDED_NS"
                
                if [[ "$excluded" == "true" ]]; then
                  log DEBUG "Skipping excluded namespace: $ns (pattern: $matched_pattern)"
                  ((namespaces_excluded++))
                  continue
                fi
                
                ((namespaces_processed++))
                log INFO "========================================="
                log INFO "Processing namespace [$namespaces_processed]: $ns"
                log INFO "========================================="
                
                # Get ConfigMaps in namespace
                if ! cm_list=$(oc get cm -n "$ns" -o name 2>/dev/null); then
                  log WARN "Unable to list ConfigMaps in namespace: $ns (permission denied or error)"
                  ((total_errors++))
                  continue
                fi
                
                if [[ -z "$cm_list" ]]; then
                  log INFO "No ConfigMaps found in namespace: $ns"
                  continue
                fi
                
                cm_count=$(echo "$cm_list" | wc -l)
                log INFO "Found $cm_count ConfigMap(s) in namespace: $ns"
                
                deleted_in_ns=0
                skipped_in_ns=0
                
                while IFS= read -r cm_name_full; do
                  [[ -z "$cm_name_full" ]] && continue
                  name=$(echo "$cm_name_full" | cut -d'/' -f2)
                  
                  log DEBUG "Evaluating ConfigMap: $name in namespace: $ns"
                  
                  # Get ConfigMap metadata (using JSON for reliability)
                  if ! cm_json=$(oc get cm "$name" -n "$ns" -o json 2>/dev/null); then
                    log WARN "Unable to get ConfigMap details: $name in $ns (skipping)"
                    ((skipped_in_ns++))
                    ((total_errors++))
                    continue
                  fi
                  
                  # Check for protected labels
                  skip=false
                  protected_by=""
                  while IFS= read -r label_rule; do
                    [[ -z "$label_rule" ]] && continue
                    
                    if [[ "$label_rule" == *"="* ]]; then
                      # Key=value format (e.g., "app.kubernetes.io/managed-by=argocd")
                      key="${label_rule%=*}"
                      value="${label_rule#*=}"
                      actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"${key}\" // empty" 2>/dev/null || echo "")
                      
                      if [[ -n "$actual_value" && "$actual_value" == "$value" ]]; then
                        log INFO "PROTECTED: ConfigMap has label [$key=$value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        ((total_protected++))
                        break
                      fi
                    else
                      # Key-only format (e.g., "prune.protected")
                      if echo "$cm_json" | jq -e ".metadata.labels.\"${label_rule}\"" &>/dev/null; then
                        actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"${label_rule}\"" 2>/dev/null)
                        log INFO "PROTECTED: ConfigMap has label [$label_rule=$actual_value] - namespace=$ns name=$name"
                        skip=true
                        protected_by="$label_rule"
                        ((total_protected++))
                        break
                      fi
                    fi
                  done <<< "$PROTECTED_LABELS"
                  
                  if [[ "$skip" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # Check age (only if MIN_AGE_DAYS > 0)
                  if [[ "$MIN_AGE_DAYS" -gt 0 ]]; then
                    created=$(echo "$cm_json" | jq -r '.metadata.creationTimestamp' 2>/dev/null || echo "")
                    if [[ -n "$created" && "$created" != "null" ]]; then
                      if created_epoch=$(date -d "$created" +%s 2>/dev/null); then
                        current_epoch=$(date +%s)
                        age_days=$(( (current_epoch - created_epoch) / 86400 ))
                        
                        if [[ "$age_days" -lt "$MIN_AGE_DAYS" ]]; then
                          log INFO "TOO NEW: ConfigMap is $age_days days old (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                          ((skipped_in_ns++))
                          ((total_too_new++))
                          continue
                        fi
                        log DEBUG "ConfigMap age: $age_days days (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                      else
                        log WARN "Unable to parse creation timestamp for ConfigMap: $name in $ns"
                      fi
                    fi
                  fi
                  
                  # Check if referenced by any workload
                  log DEBUG "Checking workload references - namespace=$ns name=$name"
                  referenced=false
                  
                  # Get all workloads that might reference ConfigMaps
                  if workloads=$(oc get pod,deploy,deployment,ds,daemonset,sts,statefulset,job,cronjob,rs,replicaset -n "$ns" -o yaml 2>/dev/null); then
                    # Check for configMap name references in volumes or envFrom
                    # This checks for:
                    # - volumes.configMap.name: <name>
                    # - envFrom.configMapRef.name: <name>
                    # - env.valueFrom.configMapKeyRef.name: <name>
                    if echo "$workloads" | grep -E "(configMap:|configMapRef:|configMapKeyRef:)" -A 2 | grep -q "name: $name"; then
                      log INFO "REFERENCED: ConfigMap is in use by workload - namespace=$ns name=$name"
                      referenced=true
                      ((total_referenced++))
                    fi
                  else
                    log WARN "Unable to check workload references in namespace: $ns (assuming ConfigMap is safe to delete)"
                  fi
                  
                  if [[ "$referenced" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # DELETE or DRY RUN
                  if [[ "$DRY_RUN" == "false" ]]; then
                    log WARN "DELETING: Unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    if oc delete cm "$name" -n "$ns" 2>&1; then
                      ((deleted_in_ns++))
                      ((total_deleted++))
                      log INFO "Successfully deleted ConfigMap - namespace=$ns name=$name"
                    else
                      log ERROR "Failed to delete ConfigMap - namespace=$ns name=$name"
                      ((skipped_in_ns++))
                      ((total_errors++))
                    fi
                  else
                    log INFO "DRY-RUN: Would delete unreferenced ConfigMap - namespace=$ns name=$name age_days=${age_days:-unknown}"
                    ((deleted_in_ns++))
                    ((total_deleted++))
                  fi
                  
                done <<< "$cm_list"
                
                log INFO "Namespace summary - namespace=$ns deleted=$deleted_in_ns skipped=$skipped_in_ns"
                ((total_skipped += skipped_in_ns))
                
              done <<< "$namespace_list"
              
              log INFO "========================================="
              log INFO "Job Completed Successfully"
              log INFO "========================================="
              log INFO "Summary Statistics:"
              log INFO "  Total namespaces in cluster: $namespace_count"
              log INFO "  Namespaces excluded: $namespaces_excluded"
              log INFO "  Namespaces processed: $namespaces_processed"
              log INFO "  ConfigMaps deleted/would delete: $total_deleted"
              log INFO "  ConfigMaps skipped: $total_skipped"
              log INFO "    - Protected by labels: $total_protected"
              log INFO "    - Too new (< $MIN_AGE_DAYS days): $total_too_new"
              log INFO "    - Referenced by workloads: $total_referenced"
              log INFO "  Errors encountered: $total_errors"
              log INFO "  Dry run mode: $DRY_RUN"
              log INFO "========================================="
              
              exit 0
)
              fi
              
              # Load protected labels with fallback
              PROTECTED_LABELS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.protectedLabels}' 2>/dev/null)
              if [[ -z "$PROTECTED_LABELS" ]]; then
                log WARN "protectedLabels not found in ConfigMap, using defaults"
                PROTECTED_LABELS=$(printf 'app.kubernetes.io/managed-by=argocd\nmeta.helm.sh/release-name\nprune.protected=true')
              fi
              
              # Trim any trailing/leading whitespace and empty lines
              EXCLUDED_NS=$(echo "$EXCLUDED_NS" | sed '/^[[:space:]]*$/d')
              PROTECTED_LABELS=$(echo "$PROTECTED_LABELS" | sed '/^[[:space:]]*$/d')
              
              # Validate configuration
              if [[ ! "$MIN_AGE_DAYS" =~ ^[0-9]+$ ]]; then
                error_exit "Invalid minAgeDays value: $MIN_AGE_DAYS (must be a number)"
              fi
              
              log INFO "Configuration loaded successfully:"
              log INFO "  DRY_RUN: $DRY_RUN"
              log INFO "  MIN_AGE_DAYS: $MIN_AGE_DAYS"
              
              # Debug: Show excluded namespace patterns
              excluded_count=$(echo "$EXCLUDED_NS" | grep -c "^" || echo "0")
              log INFO "  EXCLUDED_NS patterns ($excluded_count):"
              while IFS= read -r pattern; do
                [[ -n "$pattern" ]] && log INFO "    - $pattern"
              done <<< "$EXCLUDED_NS"
              
              # Debug: Show protected labels
              label_count=$(echo "$PROTECTED_LABELS" | grep -c "^" || echo "0")
              log INFO "  PROTECTED_LABELS ($label_count):"
              while IFS= read -r label; do
                [[ -n "$label" ]] && log INFO "    - $label"
              done <<< "$PROTECTED_LABELS"
              
              # Verify oc command works
              if ! oc whoami &>/dev/null; then
                error_exit "Unable to authenticate with OpenShift cluster"
              fi
              
              log INFO "Authenticated as: $(oc whoami)"
              
              # Get list of namespaces
              if ! oc get ns &>/dev/null; then
                error_exit "Unable to list namespaces - check RBAC permissions"
              fi
              
              namespace_list=$(oc get ns -o name 2>/dev/null | cut -d'/' -f2)
              namespace_count=$(echo "$namespace_list" | wc -l)
              log INFO "Found $namespace_count namespaces to process"
              
              total_deleted=0
              total_skipped=0
              total_protected=0
              total_too_new=0
              total_referenced=0
              namespaces_processed=0
              
              while IFS= read -r ns; do
                [[ -z "$ns" ]] && continue
                
                # Check if namespace is excluded
                excluded=false
                while IFS= read -r pattern; do
                  [[ -z "$pattern" ]] && continue
                  if echo "$ns" | grep -Eq "$pattern"; then
                    log INFO "Skipping excluded namespace: $ns (matched pattern: $pattern)"
                    excluded=true
                    break
                  fi
                done <<< "$EXCLUDED_NS"
                
                [[ "$excluded" == "true" ]] && continue
                
                ((namespaces_processed++))
                log INFO "========================================="
                log INFO "Processing namespace: $ns ($namespaces_processed/$namespace_count non-excluded)"
                log INFO "========================================="
                
                # Get ConfigMaps in namespace
                if ! cm_list=$(oc get cm -n "$ns" -o name 2>/dev/null); then
                  log WARN "Unable to list ConfigMaps in namespace: $ns (skipping)"
                  continue
                fi
                
                cm_count=$(echo "$cm_list" | grep -c "configmap/" || echo "0")
                log INFO "Found $cm_count ConfigMaps in namespace: $ns"
                
                [[ "$cm_count" -eq 0 ]] && continue
                
                deleted_in_ns=0
                skipped_in_ns=0
                
                while IFS= read -r cm_name_full; do
                  [[ -z "$cm_name_full" ]] && continue
                  name=$(echo "$cm_name_full" | cut -d'/' -f2)
                  
                  log DEBUG "Evaluating ConfigMap: $name in namespace: $ns"
                  
                  # Get ConfigMap metadata
                  if ! cm_json=$(oc get cm "$name" -n "$ns" -o json 2>/dev/null); then
                    log WARN "Unable to get ConfigMap details: $name in $ns (skipping)"
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # Check for protected labels
                  skip=false
                  while IFS= read -r label_rule; do
                    [[ -z "$label_rule" ]] && continue
                    
                    if [[ "$label_rule" == *"="* ]]; then
                      # Key=value format
                      key="${label_rule%=*}"
                      value="${label_rule#*=}"
                      actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"$key\" // empty" 2>/dev/null || echo "")
                      
                      if [[ "$actual_value" == "$value" ]]; then
                        log INFO "PROTECTED: ConfigMap has protected label [$label_rule] - namespace=$ns name=$name"
                        skip=true
                        ((total_protected++))
                        break
                      fi
                    else
                      # Key-only format
                      if echo "$cm_json" | jq -e ".metadata.labels.\"$label_rule\"" &>/dev/null; then
                        log INFO "PROTECTED: ConfigMap has protected label [$label_rule] - namespace=$ns name=$name"
                        skip=true
                        ((total_protected++))
                        break
                      fi
                    fi
                  done <<< "$PROTECTED_LABELS"
                  
                  if [[ "$skip" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # Check age
                  if [[ "$MIN_AGE_DAYS" -gt 0 ]]; then
                    created=$(echo "$cm_json" | jq -r '.metadata.creationTimestamp' 2>/dev/null)
                    if [[ -n "$created" && "$created" != "null" ]]; then
                      created_epoch=$(date -d "$created" +%s 2>/dev/null || echo "0")
                      current_epoch=$(date +%s)
                      age_days=$(( (current_epoch - created_epoch) / 86400 ))
                      
                      if [[ "$age_days" -lt "$MIN_AGE_DAYS" ]]; then
                        log INFO "TOO NEW: ConfigMap is only $age_days days old (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                        ((skipped_in_ns++))
                        ((total_too_new++))
                        continue
                      fi
                      log DEBUG "ConfigMap age: $age_days days - namespace=$ns name=$name"
                    fi
                  fi
                  
                  # Check if referenced by any workload
                  log DEBUG "Checking if ConfigMap is referenced - namespace=$ns name=$name"
                  referenced=false
                  
                  if workloads=$(oc get pod,deploy,ds,sts,job,cronjob,rs -n "$ns" -o yaml 2>/dev/null); then
                    # Check for direct name reference in configMapRef or volumes
                    if echo "$workloads" | grep -E "(configMap:|configMapRef:)" | grep -q "name: $name"; then
                      log INFO "REFERENCED: ConfigMap is referenced by workload - namespace=$ns name=$name"
                      referenced=true
                      ((total_referenced++))
                    fi
                  else
                    log WARN "Unable to check workload references in namespace: $ns"
                  fi
                  
                  if [[ "$referenced" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # DELETE or DRY RUN
                  if [[ "$DRY_RUN" == "false" ]]; then
                    log WARN "DELETING: Unreferenced ConfigMap - namespace=$ns name=$name"
                    if oc delete cm "$name" -n "$ns" 2>/dev/null; then
                      ((deleted_in_ns++))
                      ((total_deleted++))
                      log INFO "Successfully deleted ConfigMap - namespace=$ns name=$name"
                    else
                      log ERROR "Failed to delete ConfigMap - namespace=$ns name=$name"
                      ((skipped_in_ns++))
                    fi
                  else
                    log INFO "DRY-RUN: Would delete unreferenced ConfigMap - namespace=$ns name=$name"
                    ((deleted_in_ns++))
                  fi
                  
                done <<< "$cm_list"
                
                log INFO "Namespace summary - namespace=$ns deleted=$deleted_in_ns skipped=$skipped_in_ns"
                ((total_skipped += skipped_in_ns))
                
              done <<< "$namespace_list"
              
              log INFO "========================================="
              log INFO "Job Completed Successfully"
              log INFO "========================================="
              log INFO "Summary:"
              log INFO "  Namespaces processed: $namespaces_processed"
              log INFO "  ConfigMaps deleted/would delete: $total_deleted"
              log INFO "  ConfigMaps skipped: $total_skipped"
              log INFO "    - Protected by labels: $total_protected"
              log INFO "    - Too new: $total_too_new"
              log INFO "    - Referenced by workloads: $total_referenced"
              log INFO "  Dry run mode: $DRY_RUN"
              log INFO "========================================="
              
              exit 0


======================
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cm-secret-pruner
  namespace: openshift-operators
spec:
  schedule: "34 19 * * *"  # Daily at 7:34 PM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        spec:
          serviceAccountName: cm-secret-pruner
          restartPolicy: Never  # Changed from OnFailure to Never
          containers:
          - name: pruner
            image: registry.redhat.io/openshift4/ose-cli:v4.16
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
            command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              
              # Enhanced logging with color support
              log() {
                level="$1"
                shift
                echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $*"
              }
              
              # Error handler
              error_exit() {
                log ERROR "$1"
                exit 1
              }
              
              # Trap errors
              trap 'error_exit "Script failed at line $LINENO"' ERR
              
              log INFO "========================================="
              log INFO "ConfigMap Pruner Job Started"
              log INFO "========================================="
              
              NS="openshift-operators"
              CM="cm-secret-pruner-config"
              
              # Verify ConfigMap exists
              if ! oc -n "$NS" get cm "$CM" &>/dev/null; then
                error_exit "ConfigMap $CM not found in namespace $NS"
              fi
              
              log INFO "ConfigMap found: $CM in namespace $NS"
              
              # Load configuration with validation
              DRY_RUN=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.dryRun}' 2>/dev/null || echo "true")
              MIN_AGE_DAYS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.minAgeDays}' 2>/dev/null || echo "30")
              EXCLUDED_NS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.excludedNamespaces}' 2>/dev/null || echo "^openshift-.*
^kube-.*
^default$
^openshift$")
              PROTECTED_LABELS=$(oc -n "$NS" get cm "$CM" -o jsonpath='{.data.protectedLabels}' 2>/dev/null || echo "app.kubernetes.io/managed-by=argocd
meta.helm.sh/release-name
prune.protected=true")
              
              # Validate configuration
              if [[ ! "$MIN_AGE_DAYS" =~ ^[0-9]+$ ]]; then
                error_exit "Invalid minAgeDays value: $MIN_AGE_DAYS (must be a number)"
              fi
              
              log INFO "Configuration loaded successfully:"
              log INFO "  DRY_RUN: $DRY_RUN"
              log INFO "  MIN_AGE_DAYS: $MIN_AGE_DAYS"
              log INFO "  EXCLUDED_NS patterns: $(echo "$EXCLUDED_NS" | wc -l) patterns"
              log INFO "  PROTECTED_LABELS: $(echo "$PROTECTED_LABELS" | wc -l) labels"
              
              # Verify oc command works
              if ! oc whoami &>/dev/null; then
                error_exit "Unable to authenticate with OpenShift cluster"
              fi
              
              log INFO "Authenticated as: $(oc whoami)"
              
              # Get list of namespaces
              if ! oc get ns &>/dev/null; then
                error_exit "Unable to list namespaces - check RBAC permissions"
              fi
              
              namespace_list=$(oc get ns -o name 2>/dev/null | cut -d'/' -f2)
              namespace_count=$(echo "$namespace_list" | wc -l)
              log INFO "Found $namespace_count namespaces to process"
              
              total_deleted=0
              total_skipped=0
              total_protected=0
              total_too_new=0
              total_referenced=0
              namespaces_processed=0
              
              while IFS= read -r ns; do
                [[ -z "$ns" ]] && continue
                
                # Check if namespace is excluded
                excluded=false
                while IFS= read -r pattern; do
                  [[ -z "$pattern" ]] && continue
                  if echo "$ns" | grep -Eq "$pattern"; then
                    log INFO "Skipping excluded namespace: $ns (matched pattern: $pattern)"
                    excluded=true
                    break
                  fi
                done <<< "$EXCLUDED_NS"
                
                [[ "$excluded" == "true" ]] && continue
                
                ((namespaces_processed++))
                log INFO "========================================="
                log INFO "Processing namespace: $ns ($namespaces_processed/$namespace_count non-excluded)"
                log INFO "========================================="
                
                # Get ConfigMaps in namespace
                if ! cm_list=$(oc get cm -n "$ns" -o name 2>/dev/null); then
                  log WARN "Unable to list ConfigMaps in namespace: $ns (skipping)"
                  continue
                fi
                
                cm_count=$(echo "$cm_list" | grep -c "configmap/" || echo "0")
                log INFO "Found $cm_count ConfigMaps in namespace: $ns"
                
                [[ "$cm_count" -eq 0 ]] && continue
                
                deleted_in_ns=0
                skipped_in_ns=0
                
                while IFS= read -r cm_name_full; do
                  [[ -z "$cm_name_full" ]] && continue
                  name=$(echo "$cm_name_full" | cut -d'/' -f2)
                  
                  log DEBUG "Evaluating ConfigMap: $name in namespace: $ns"
                  
                  # Get ConfigMap metadata
                  if ! cm_json=$(oc get cm "$name" -n "$ns" -o json 2>/dev/null); then
                    log WARN "Unable to get ConfigMap details: $name in $ns (skipping)"
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # Check for protected labels
                  skip=false
                  while IFS= read -r label_rule; do
                    [[ -z "$label_rule" ]] && continue
                    
                    if [[ "$label_rule" == *"="* ]]; then
                      # Key=value format
                      key="${label_rule%=*}"
                      value="${label_rule#*=}"
                      actual_value=$(echo "$cm_json" | jq -r ".metadata.labels.\"$key\" // empty" 2>/dev/null || echo "")
                      
                      if [[ "$actual_value" == "$value" ]]; then
                        log INFO "PROTECTED: ConfigMap has protected label [$label_rule] - namespace=$ns name=$name"
                        skip=true
                        ((total_protected++))
                        break
                      fi
                    else
                      # Key-only format
                      if echo "$cm_json" | jq -e ".metadata.labels.\"$label_rule\"" &>/dev/null; then
                        log INFO "PROTECTED: ConfigMap has protected label [$label_rule] - namespace=$ns name=$name"
                        skip=true
                        ((total_protected++))
                        break
                      fi
                    fi
                  done <<< "$PROTECTED_LABELS"
                  
                  if [[ "$skip" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # Check age
                  if [[ "$MIN_AGE_DAYS" -gt 0 ]]; then
                    created=$(echo "$cm_json" | jq -r '.metadata.creationTimestamp' 2>/dev/null)
                    if [[ -n "$created" && "$created" != "null" ]]; then
                      created_epoch=$(date -d "$created" +%s 2>/dev/null || echo "0")
                      current_epoch=$(date +%s)
                      age_days=$(( (current_epoch - created_epoch) / 86400 ))
                      
                      if [[ "$age_days" -lt "$MIN_AGE_DAYS" ]]; then
                        log INFO "TOO NEW: ConfigMap is only $age_days days old (min: $MIN_AGE_DAYS) - namespace=$ns name=$name"
                        ((skipped_in_ns++))
                        ((total_too_new++))
                        continue
                      fi
                      log DEBUG "ConfigMap age: $age_days days - namespace=$ns name=$name"
                    fi
                  fi
                  
                  # Check if referenced by any workload
                  log DEBUG "Checking if ConfigMap is referenced - namespace=$ns name=$name"
                  referenced=false
                  
                  if workloads=$(oc get pod,deploy,ds,sts,job,cronjob,rs -n "$ns" -o yaml 2>/dev/null); then
                    # Check for direct name reference in configMapRef or volumes
                    if echo "$workloads" | grep -E "(configMap:|configMapRef:)" | grep -q "name: $name"; then
                      log INFO "REFERENCED: ConfigMap is referenced by workload - namespace=$ns name=$name"
                      referenced=true
                      ((total_referenced++))
                    fi
                  else
                    log WARN "Unable to check workload references in namespace: $ns"
                  fi
                  
                  if [[ "$referenced" == "true" ]]; then
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # DELETE or DRY RUN
                  if [[ "$DRY_RUN" == "false" ]]; then
                    log WARN "DELETING: Unreferenced ConfigMap - namespace=$ns name=$name"
                    if oc delete cm "$name" -n "$ns" 2>/dev/null; then
                      ((deleted_in_ns++))
                      ((total_deleted++))
                      log INFO "Successfully deleted ConfigMap - namespace=$ns name=$name"
                    else
                      log ERROR "Failed to delete ConfigMap - namespace=$ns name=$name"
                      ((skipped_in_ns++))
                    fi
                  else
                    log INFO "DRY-RUN: Would delete unreferenced ConfigMap - namespace=$ns name=$name"
                    ((deleted_in_ns++))
                  fi
                  
                done <<< "$cm_list"
                
                log INFO "Namespace summary - namespace=$ns deleted=$deleted_in_ns skipped=$skipped_in_ns"
                ((total_skipped += skipped_in_ns))
                
              done <<< "$namespace_list"
              
              log INFO "========================================="
              log INFO "Job Completed Successfully"
              log INFO "========================================="
              log INFO "Summary:"
              log INFO "  Namespaces processed: $namespaces_processed"
              log INFO "  ConfigMaps deleted/would delete: $total_deleted"
              log INFO "  ConfigMaps skipped: $total_skipped"
              log INFO "    - Protected by labels: $total_protected"
              log INFO "    - Too new: $total_too_new"
              log INFO "    - Referenced by workloads: $total_referenced"
              log INFO "  Dry run mode: $DRY_RUN"
              log INFO "========================================="
              
              exit 0





cluster-addons/
 configmap-secret-pruner/
     kustomization.yaml
     cronjob.yaml
     configmap.yaml
     rbac.yaml



resources:
- cronjob.yaml
- configmap.yaml
- rbac.yaml


apiVersion: v1
kind: ConfigMap
meta
  name: cm-secret-pruner-config
  namespace: openshift-operators

  # Regex: namespaces to skip (one per line)
  excludedNamespaces: |
    ^openshift-.*
    ^kube-.*
    ^default$
    ^openshift$

  # Labels that protect resources (key[=value], pipe-separated)
  protectedLabels: "app.kubernetes.io/managed-by=argocd|meta.helm.sh/release-name|prune.protected=true"

  # Min age in days (0 = disable)
  minAgeDays: "30"

  # Dry-run mode: "true" = log only, "false" = delete
  dryRun: "true"


apiVersion: v1
kind: ServiceAccount
meta
  name: cm-secret-pruner
  namespace: openshift-operators
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
meta
  name: cm-secret-pruner-role
rules:
- apiGroups: [""]
  resources: ["namespaces", "configmaps", "secrets", "pods", "serviceaccounts"]
  verbs: ["get", "list"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
  verbs: ["get", "list"]
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list"]
- apiGroups: ["argoproj.io"]
  resources: ["rollouts"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["delete"]  # Only delete, no create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
meta
  name: cm-secret-pruner-binding
subjects:
- kind: ServiceAccount
  name: cm-secret-pruner
  namespace: openshift-operators
roleRef:
  kind: ClusterRole
  name: cm-secret-pruner-role
  apiGroup: rbac.authorization.k8s.io



apiVersion: batch/v1
kind: CronJob
meta
  name: cm-secret-pruner
  namespace: openshift-operators
spec:
  schedule: "0 3 * * 0"  # Weekly at 3 AM UTC
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cm-secret-pruner
          containers:
          - name: pruner
            image: registry.redhat.io/openshift4/ose-cli:v4.16
            command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              log() { echo "$(date '+%Y-%m-%d %H:%M:%S') $*"; }
              
              NS="openshift-operators"
              CM="cm-secret-pruner-config"
              
              dry_run() { oc -n "$NS" get cm "$CM" -o jsonpath='{.data.dryRun}' 2>/dev/null || echo "true"; }
              min_age() { oc -n "$NS" get cm "$CM" -o jsonpath='{.data.minAgeDays}' 2>/dev/null || echo "30"; }
              excluded_ns() { oc -n "$NS" get cm "$CM" -o jsonpath='{.data.excludedNamespaces}' 2>/dev/null || echo "^openshift-.*|^kube-.*|^default$|^openshift$"; }
              protected_labels() { oc -n "$NS" get cm "$CM" -o jsonpath='{.data.protectedLabels}' 2>/dev/null || echo "app.kubernetes.io/managed-by=argocd|meta.helm.sh/release-name|prune.protected=true"; }
              
              DRY_RUN=$(dry_run)
              MIN_AGE_DAYS=$(min_age)
              EXCLUDED_NS=$(excluded_ns)
              PROTECTED_LABELS=$(protected_labels)
              
              total_deleted=0
              total_skipped=0
              
              while IFS= read -r ns; do
                [[ -z "$ns" ]] && continue
                if echo "$ns" | grep -Eq "$EXCLUDED_NS"; then
                  log INFO "Skipping excluded namespace namespace=$ns"
                  continue
                fi
                
                log INFO "Processing namespace namespace=$ns"
                oc get cm -n "$ns" -o name 2>/dev/null | cut -d'/' -f2 > /tmp/candidates.txt || true
                
                deleted_in_ns=0
                skipped_in_ns=0
                
                while IFS= read -r name; do
                  # Skip protected by label
                  labels=$(oc get cm "$name" -n "$ns" -o jsonpath='{.metadata.labels}' 2>/dev/null || echo "")
                  skip=false
                  for label in $(echo "$PROTECTED_LABELS" | tr '|' '\n'); do
                    key="${label%=*}"
                    if [[ "$labels" == *"$key"* ]]; then
                      log INFO "Skipping protected ConfigMap namespace=$ns configmap=$name reason=\"label: $label\""
                      skip=true; break
                    fi
                  done
                  [[ "$skip" == "true" ]] && { ((skipped_in_ns++)); continue; }
                  
                  # Check age
                  if [[ "$MIN_AGE_DAYS" -gt 0 ]]; then
                    created=$(oc get cm "$name" -n "$ns" -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null)
                    if [[ -n "$created" ]]; then
                      age_days=$(( ($(date +%s) - $(date -d "$created" +%s)) / 86400 ))
                      if [[ "$age_days" -lt "$MIN_AGE_DAYS" ]]; then
                        log INFO "Skipping ConfigMap (too new) namespace=$ns configmap=$name age_days=$age_days"
                        ((skipped_in_ns++))
                        continue
                      fi
                    fi
                  fi
                  
                  # Check if referenced
                  if oc get pod,deploy,ds,sts,job,cronjob,rs -n "$ns" -o yaml 2>/dev/null | grep -q "name: $name"; then
                    log INFO "Skipping referenced ConfigMap namespace=$ns configmap=$name"
                    ((skipped_in_ns++))
                    continue
                  fi
                  
                  # DELETE
                  if [[ "$DRY_RUN" == "false" ]]; then
                    log INFO "Deleting unreferenced ConfigMap namespace=$ns configmap=$name"
                    oc delete cm "$name" -n "$ns" >/dev/null
                    ((deleted_in_ns++))
                  else
                    log DRYRUN "Would delete unreferenced ConfigMap namespace=$ns configmap=$name"
                  fi
                done < /tmp/candidates.txt
                
                log INFO "Namespace pruning summary namespace=$ns deleted=$deleted_in_ns skipped=$skipped_in_ns"
                ((total_deleted += deleted_in_ns))
                ((total_skipped += skipped_in_ns))
                
              done < <(oc get ns -o name 2>/dev/null | cut -d'/' -f2)
              
              log INFO "Cluster pruning completed total_deleted=$total_deleted total_skipped=$total_skipped dry_run=$DRY_RUN"
          restartPolicy: OnFailure  
